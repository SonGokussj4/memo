@{
    ViewData["Title"] = "Nová nabídka";
}

@model memo.ViewModels.OfferViewModel

@await Html.PartialAsync("_PartialToastNotification")

<div class="text-center">
    <h1 class="display-6">@ViewData["Title"]</h1>
    <hr />
</div>

<div class="container d-flex justify-content-center">
    <div class="col-lg-10 personal-info">
        <form class="card" role="form" autocomplete="on" asp-action="Create" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="form-group row">
            <label asp-for="Offer.OfferName" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <span class="has-float-label">
                    <input asp-for="Offer.OfferName" class="form-control" placeholder="EV(E)-quo/rrrr/dddd" type="text" />
                    <label asp-for="Offer.OfferName"></label>
                </span>
                <span asp-validation-for="Offer.OfferName" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Offer.SharedInfo.ReceiveDate" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9 mycalendar">
                <span class="has-float-label">
                    <input asp-for="Offer.SharedInfo.ReceiveDate" class="form-control" type="text" placeholder=" " required="" autocomplete="off"/>
                    <label asp-for="Offer.SharedInfo.ReceiveDate">Datum přijetí poptávky</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.ReceiveDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Offer.SentDate" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9 mycalendar">
                <span class="has-float-label">
                    <input asp-for="Offer.SentDate" class="form-control" type="text" placeholder=" " autocomplete="off"/>
                    <label asp-for="Offer.SentDate">Datum odeslání nabídky</label>
                </span>
                <span asp-validation-for="Offer.SentDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Offer.SharedInfo.Subject" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <span class="has-float-label">
                    <input asp-for="Offer.SharedInfo.Subject" class="form-control" placeholder="Krátký popis nabídky" type="text" />
                    <label asp-for="Offer.SharedInfo.Subject">Předmět nabídky</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.Subject" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row eveOffer">
            <label class="col-lg-3 col-form-label form-control-label control-label">Evektor</label>
            <div class="col-lg-2">
                <span class="floating-select-label">Divize</span>
                <select class="form-control" asp-for="Offer.SharedInfo.EveDivision" asp-items="@Model.Offer.EveDivisionList"></select>
                <span asp-validation-for="Offer.SharedInfo.EveDivision" class="text-danger"></span>
            </div>
            <div class="col-lg-3">
                <span class="floating-select-label">Oddělení</span>
                <select asp-for="Offer.SharedInfo.EveDepartment" class="select-department form-control"></select>
                <span asp-validation-for="Offer.SharedInfo.EveDepartment" class="text-danger"></span>
            </div>
            <div class="col-lg-4">
                <span class="floating-select-label">Uživatel</span>
                <select class="form-control select-user" asp-for="Offer.SharedInfo.EveCreatedUser"></select>
                <span asp-validation-for="Offer.SharedInfo.EveCreatedUser" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row customerOffer">
            <label class="required col-lg-3 col-form-label form-control-label control-label">Zákazník</label>
            <div class="col-lg-4">
                <span class="floating-select-label">Firma zákazníka</span>
                <select class="form-control select-company" asp-for="Offer.SharedInfo.CompanyId" ></select>
                <span asp-validation-for="Offer.SharedInfo.CompanyId" class="text-danger"></span>
            </div>
            <div class="col-lg-1" data-toggle="tooltip" title="Nová firma">
                <a asp-action="create" asp-controller="Companies" target="_blank">
                    <i class="form-control fa fa-plus-circle" style="color: green; cursor: pointer;"></i>
                </a>
            </div>
            <div class="col-lg-3">
                <span class="floating-select-label">Kontakt</span>
                <select class="form-control select-contact" asp-for="Offer.SharedInfo.ContactId"></select>
                <span asp-validation-for="Offer.SharedInfo.ContactId" class="text-danger"></span>
            </div>
            <div class="col-lg-1" data-toggle="tooltip" title="Nový kontakt">
                <a asp-action="create" asp-controller="Contacts" target="_blank">
                    <i class="form-control fa fa-plus-circle" style="color: green; cursor: pointer;"></i>
                </a>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Offer.SharedInfo.Price" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-5">
                <span class="has-float-label">
                    <input asp-for="Offer.SharedInfo.Price" class="form-control" type="text" placeholder=" "/>
                    <label asp-for="Offer.SharedInfo.Price">Cena bez DPH</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.Price" class="text-danger"></span>
            </div>
            <div class="col-lg-4">
                <span class="has-float-label" data-toggle="tooltip" title="Aktuální kurz ČNB">
                    <select asp-for="Offer.SharedInfo.CurrencyId" asp-items="Model.CurrencyList" class="form-control"></select>
                    <label asp-for="Offer.SharedInfo.CurrencyId">Měna</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.CurrencyId" class="text-danger"></span>
            </div>

            @* <div class="col-lg-2">
                <span class="has-float-label">
                    <select asp-for="Offer.SharedInfo.CurrencyId" asp-items="ViewBag.CurrencyList" class="form-control"></select>
                    <label asp-for="Offer.SharedInfo.CurrencyId">Měna</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.Currency" class="text-danger"></span>
            </div>
            <div class="col-lg-2">
                <span class="has-float-label">
                    <input asp-for="Offer.SharedInfo.ExchangeRate" class="form-control" type="text" data-toggle="tooltip" data-placement="top" title="Měnový kurz z ČNB" />
                    <label asp-for="Offer.SharedInfo.ExchangeRate">Kurz</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.ExchangeRate" class="text-danger"></span>
            </div> *@
        </div>

        <div class="form-group row">
            <label asp-for="Offer.SharedInfo.EstimatedFinishDate" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9 mycalendar">
                <span class="has-float-label">
                    <input asp-for="Offer.SharedInfo.EstimatedFinishDate" class="form-control" type="text" autocomplete="off" placeholder=" "/>
                    <label asp-for="Offer.SharedInfo.EstimatedFinishDate">Předpodkládaný termín ukončení</label>
                </span>
                <span asp-validation-for="Offer.SharedInfo.EstimatedFinishDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Offer.Notes" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <span class="has-float-label">
                    <textarea asp-for="Offer.Notes" class="form-control" placeholder=" "></textarea>
                    <label asp-for="Offer.Notes">Poznámky</label>
                </span>
                <span asp-validation-for="Offer.Notes" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-lg-3">
                <a asp-action="Index" class="btn btn-light border"><i class="fa fa-arrow-left"></i> Zpět</a>
            </div>
            <div class="col-lg-9">
                <input type="submit" class="btn btn-primary" value="Vytvořit nabídku" />
            </div>
        </div>

        </form>
    </div>
</div>

@section Scripts {

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>

        $(".select-department").select2({
            placeholder: "-- Vyber oddělení --",
            minimumInputLength: 0,  // minimum number of characters required to start a search
            dropdownAutoWidth: true,  // make width of the dropdown to MAX of the longest item
            allowClear: false,  // 'times' button to click for emptying selection
            minimumResultsForSearch: 0,  // '-1' to disable search box
            language: { searching: function() { return null; } }, // disable/change "Searching..." text
            ajax: {
                url: '@Url.Action("getDepartmentsJson", "Evektor")',
                dataType: 'json',
                type: 'Get',
                delay: 150,
                data: function (params) {
                    return {
                        match: params.term,  // search term
                        pageSize: params.pageSize || 100,  // how many items on page
                    };
                },
                processResults: function (data) {
                    return {
                        // data = return Json { items = [ { id: 1, text: "one" }, { id: 2, text: "two" } ] }
                        @* results: data.items *@
                        // data = return Json { items = [ SelectListItem { Value: 1, Text: "one" }, SelectListItem { Value: 2, Text: "two" } ] }
                        results: $.map(data.items, function(item) {
                            return {
                                id: item.value,  // need to be lowercase "v"
                                text: item.text  // need to be lowercase "t"
                            }
                        }),
                    };
                },
                cache: true,
            },
        });

        // Clear and unselect '.select-user' when '.select-department' changes it's value
        $('.select-department').on('select2:select', function (e) {
            $(".select-user").select2('data', null).trigger('change');
            @* $(".select-user").val(null).trigger('change').select2("disable"); *@
        });


        $(".select-user").select2({
            placeholder: "-- Vyber uživatele --",
            minimumInputLength: 0,  // minimum number of characters required to start a search
            dropdownAutoWidth: true,  // make width of the dropdown to MAX of the longest item
            allowClear: false,  // 'times' button to click for emptying selection
            minimumResultsForSearch: 0,  // '-1' to disable search box
            language: { searching: function() { return null; } }, // disable/change "Searching..." text
            ajax: {
                url: '@Url.Action("getUsersJson", "Evektor")',
                dataType: 'json',
                type: 'Get',
                delay: 150,
                data: function (params) {
                    return {
                        match: params.term,  // search term
                        pageSize: params.pageSize || 100,  // how many items on page
                        filter: $(".select-department").children("option:selected").val(),
                    };
                },
                processResults: function (data) {
                    return {
                        // data = return Json { items = [ { id: 1, text: "one" }, { id: 2, text: "two" } ] }
                        @* results: data.items *@
                        // data = return Json { items = [ SelectListItem { Value: 1, Text: "one" }, SelectListItem { Value: 2, Text: "two" } ] }
                        results: $.map(data.items, function(item) {
                            return {
                                id: item.value,  // need to be lowercase "v"
                                text: item.text  // need to be lowercase "t"
                            }
                        })
                    };
                },
                cache: true,
            },
        });

        $(".select-company").select2({
            placeholder: "-- Vyber firmu --",
            minimumInputLength: 0,  // minimum number of characters required to start a search
            dropdownAutoWidth: true,  // make width of the dropdown to MAX of the longest item
            allowClear: false,  // 'times' button to click for emptying selection
            minimumResultsForSearch: 0,  // '-1' to disable search box
            language: { searching: function() { return null; } }, // disable "Searching..." text
            ajax: {
                url: '@Url.Action("getCompaniesJson", "Companies")',
                dataType: 'json',
                type: 'Get',
                delay: 150,
                data: function (params) {
                    return {
                        match: params.term,  // search term
                        pageSize: params.pageSize || 100,  // how many items on page
                    };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data.items, function(item) {
                            return {
                                id: item.value,
                                text: item.text
                            }
                        })
                    };
                },
                cache: true,
            },
        });

        // Clear and unselect '.select-user' when '.select-department' changes it's value
        $('.select-company').on('select2:select', function (e) {
            $(".select-contact").val(null).empty().trigger('change');
        });

        $(".select-contact").select2({
            placeholder: "-- Vyber kontakt --",
            minimumInputLength: 0,  // minimum number of characters required to start a search
            dropdownAutoWidth: true,  // make width of the dropdown to MAX of the longest item
            allowClear: false,  // 'times' button to click for emptying selection
            minimumResultsForSearch: 0,  // '-1' to disable search box
            language: { searching: function() { return null; } }, // disable/change "Searching..." text
            ajax: {
                url: '@Url.Action("getContactsJson", "Contacts")',
                dataType: 'json',
                type: 'Get',
                delay: 150,
                data: function (params) {
                    return {
                        match: params.term,  // search term
                        pageSize: params.pageSize || 100,  // how many items on page
                        filter: $(".select-company").children("option:selected").val(),
                    };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data.items, function(item) {
                            return {
                                id: item.value,
                                text: item.text
                            }
                        })
                    };
                },
                cache: true,
            },
        });

        $(document).ready(function(){

            // DEFAULT VALUES
            // =======================================
            var selectDepartmentDefaultOption = new Option('@Html.Raw(Model.Offer.SharedInfo.EveDepartment)', '@Html.Raw(Model.Offer.SharedInfo.EveDepartment)', false, false);
            $('.select-department').append(selectDepartmentDefaultOption).trigger('change');

            var selectUserOption = new Option('@Html.Raw(Model.Offer.SharedInfo.EveCreatedUser)', '@Html.Raw(Model.Offer.SharedInfo.EveCreatedUser)', false, false);
            $('.select-user').append(selectUserOption).trigger('change');

            // INITIALIZATIONS
            $('.mycalendar input').datepicker(datepickerParameters[0]);

            checkItemNameExists($("#Offer_OfferName"), 'Offers');

            $("#Offer_OfferName").keyup(function() {
                checkItemNameExists($(this), 'Offers');
            });

            function changeExchangeRate(curSymbol) {
                $.ajax({
                    url: '@Url.Action("getCurrencyStr", "Offers")',
                    type: 'GET',
                    //dataType: 'json',
                    // we set cache: false because GET requests are often cached by browsers
                    // IE is particularly aggressive in that respect
                    cache: false,
                    data: { symbol: curSymbol },
                    success: function(res) {
                        $('#ExchangeRate').val(res);
                    }
                });
            }

            $('#CurrencyId').change(function() {
                var sel = document.getElementById('CurrencyId');
                var opt = sel.options[sel.selectedIndex];
                curSymbol = opt.text
                console.log("Changing... to " + curSymbol);
                changeExchangeRate(curSymbol);
            });

        })

    </script>

}

