@using System.Globalization;

@model memo.Models.Offer

@{
    if (Model.OfferStatusId == 2)
    {
        ViewData["Title"] = "Úprava objednávky";
        ViewData["SubTitle"] = "Upravit informace o objednávce";
    }
    else
    {
        ViewData["Title"] = "Úprava nabídky";
        ViewData["SubTitle"] = "Upravit informace o nabídce";
    }
}


<style>
    .offerStatus_1 {
        color: grey;
        text-align: center;
        font-weight: 600;
    }

    .offerStatus_2 {
        color: green;
        text-align: center;
        font-weight: 600;
    }

    .offerStatus_3 {
        color: red;
        text-align: center;
        font-weight: 600;
    }

    .cardTitleMerged {
        display: flex;
        justify-content: space-between;
    }

    .wonOffer {
        border: 1px solid #ced4da;
        margin: 0px -15px;
        padding: 8px 0px;
        margin-bottom: 10px;
        background-color: #00ff0d21;
        border-radius: .25rem;
    }
</style>

<div class="text-center">
    <h1 class="display-6">@ViewData["Title"]</h1>
    <hr />
</div>


<div class="container d-flex justify-content-center">
    <div class="col-lg-10 push-lg-2 ">
        <form class="card" role="form" autocomplete="on" asp-action="Edit" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <input type="hidden" asp-for="OfferId" />
        <input type="hidden" asp-for="OfferStatusId" />

        <div class="cardTitleMerged">

            <h5 class="card-title">@ViewData["SubTitle"]</h5>

            <div class="form-group">
                <div class="pretty p-bigger p-default p-curve p-toggle">
                    <input asp-for="Active" type="checkbox"/>
                    <div class="state p-success p-on">
                        <label>Aktivní</label>
                    </div>
                    <div class="state p-danger p-off">
                        <label>Neaktivní </label>
                    </div>
                </div>
                <span asp-validation-for="Active" class="text-danger"></span>
            </div>

        </div>

        <hr />

        <div class="form-group row">
            <label asp-for="OfferName" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <input asp-for="OfferName" class="form-control" type="text" readonly />
                <span asp-validation-for="OfferName" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="OfferStatusId" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-2">
                @Html.TextBox("OfferStatusName", (string)@ViewBag.OfferStatusName, new { @class = "form-control btn btn-dark offerStatus_" + Model.OfferStatusId, @readonly = "readonly" })
            </div>
            <div class="col-lg-1">
            </div>

            <div class="col-lg-2">
                <label class="col-form-label form-control-label control-label">Změnit: </label>
            </div>
            <div class="col-lg-2 offerWait" style="display: none;">
                <button class="btn btn-secondary form-control" type="submit"
                        asp-action="ChangeOfferStatus" asp-controller="Offers"
                        asp-route-id="@Model.OfferId" asp-route-btnOfferStatusId="1">
                    <i class="fa fa-hourglass-half"></i> Čeká
                </button>
            </div>
            <div class="col-lg-2 offerWon" style="display: none;">
                <button class="btn btn-success form-control" type="submit"
                        asp-action="ChangeOfferStatus" asp-controller="Offers"
                        asp-route-id="@Model.OfferId" asp-route-btnOfferStatusId="2">
                    <i class="fa fa-smile-o"></i> Výhra
                </button>
            </div>

            <div class="col-lg-2 offerLost" style="display: none;">
                <button class="btn btn-danger form-control" type="submit"
                        asp-action="ChangeOfferStatus" asp-controller="Offers"
                        asp-route-id="@Model.OfferId" asp-route-btnOfferStatusId="3">
                    <i class="fa fa-frown-o"></i> Prohra
                </button>
            </div>
        </div>

        <div class="createOffer" style="display: none;">

            <hr />
            <h5>Stávající zakázky</h5>
            <div class="form-group row">
                <ul>
                    @foreach (Order order in ViewBag.CreatedOrders)
                    {
                        <li>
                            <a asp-action="Edit" asp-controller="Orders" asp-route-id="@order.OrderId">
                                @order.OrderName
                            </a>
                            [ @order.OrderCode ] ... Celková cena: @String.Format(CultureInfo.CreateSpecificCulture("cs-CZ"), "{0:C0}", order.PriceFinalCzk) ...
                            Vyčerpáno: @( order.Burned / 60 ) h / @order.TotalHours h ... @( (float)order.Burned / 60 / order.TotalHours * 100 ) %
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="createOffer" style="display: none;">
            <hr />
            <div class="form-group row text-center">
                <div class="col-md-12 from-control">
                    <button class="col-md-4 btn btn-success mt-3" type="submit"
                            asp-action="ChangeOfferStatus" asp-controller="Offers"
                            asp-route-id="@Model.OfferId" asp-route-btnOfferStatusId="0">
                        <i class="fa fa-plus"></i> Vytvořit novou zakázku
                    </button>
                </div>
            </div>
        </div>

        @* Lost offer textarea only visible if Offer was Lost *@
        @if (Model.OfferStatusId == 3)
        {
            <div class="form-group row lostOffer">
                <label asp-for="LostReason" class="col-lg-3 col-form-label form-control-label control-label"></label>
                <div class="col-lg-9">
                    <textarea asp-for="LostReason" class="form-control"></textarea>
                    @* @Html.TextAreaFor(m => m.LostReason, additionalViewData: new { htmlAttributes = new { @class = "form-control" }}) *@
                    <span asp-validation-for="LostReason" class="text-danger"></span>
                </div>
            </div>
        }

        <hr />

        <div class="form-group row">
            <label asp-for="ReceiveDate" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9 mycalendar">
                <input asp-for="ReceiveDate" class="form-control" type="text" required="" autocomplete="off"/>
                <span asp-validation-for="ReceiveDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="SentDate" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9 mycalendar">
                <input asp-for="SentDate" class="form-control" type="text" autocomplete="off"/>
                <span asp-validation-for="SentDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Subject" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <input asp-for="Subject" class="form-control" type="text" />
                <span asp-validation-for="Subject" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row eveOffer">
            <label class="required col-lg-3 col-form-label form-control-label control-label">Evektor</label>
            <div class="col-lg-2">
                <div data-toggle="tooltip" title="Divize">
                    @Html.DropDownList("EveDivision", new SelectList(Model.EveDivisionList, "Value", "Text", "-- Divize --"), new { @class = "form-control"})
                </div>
                <span asp-validation-for="EveDivision" class="text-danger"></span>
            </div>
            <div class="col-lg-3">
                <div data-toggle="tooltip" title="Oddělení">
                    @Html.DropDownList("EveDepartment", new SelectList(ViewBag.DepartmentList, "Value", "Text"), new { @class = "form-control"})
                </div>
                <span asp-validation-for="EveDepartment" class="text-danger"></span>
            </div>
            <div class="col-lg-4">
                <div data-toggle="tooltip" title="Nabídku vytvořil">
                    @Html.DropDownList("EveCreatedUser", new SelectList(ViewBag.EveContactList, "Value", "Text"), new { @class = "form-control selectpicker"})
                </div>
                <span asp-validation-for="EveCreatedUser" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row customerOffer">
            <label class="col-lg-3 col-form-label form-control-label control-label">Zákazník</label>
            <div class="col-lg-4">
                @Html.DropDownListFor(model => model.CompanyId, ViewBag.CompanyList as SelectList, "-- Vyber firmu --", new { @class = "form-control selectpicker", @style = "width: 100%;" })
                <span asp-validation-for="CompanyId" class="text-danger"></span>
            </div>
            <div class="col-lg-1" data-toggle="tooltip" title="Nová firma">
                <a asp-for="create" asp-controller="Companies">
                    <i class="form-control fa fa-plus-circle" style="color: green; cursor: pointer;"></i>
                </a>
            </div>
            <div class="col-lg-3">
                @Html.DropDownListFor(model => model.ContactId, ViewBag.ContactList as SelectList, "-- Vyber kontakt --", new { @class = "form-control selectpicker", @style = "width: 100%;" })
                <span asp-validation-for="ContactId" class="text-danger"></span>
            </div>
            <div class="col-lg-1" data-toggle="tooltip" title="Nový kontakt">
                <a asp-for="create" asp-controller="Contacts">
                    <i class="form-control fa fa-plus-circle" style="color: green; cursor: pointer;"></i>
                </a>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Price" class="required col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-5">
                <input asp-for="Price" class="form-control" type="text" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
            <div class="col-lg-2">
                <div data-toggle="tooltip" title="Měna">
                    @Html.DropDownListFor(model => model.CurrencyId, ViewBag.CurrencyList as SelectList, new { @class = "form-control" })
                </div>
                <span asp-validation-for="Currency" class="text-danger"></span>
            </div>
            <div class="col-lg-2">
                @* <input asp-for="ExchangeRate" class="form-control" type="text" onchange="this.value = this.value.replace(/,/g, '.')"/> *@
                <input asp-for="ExchangeRate" class="form-control" type="text" data-toggle="tooltip" title="Měnový kurz: X -> CZK"/>
                <span asp-validation-for="ExchangeRate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="Notes" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-9">
                <textarea asp-for="Notes" class="form-control"></textarea>
                @* @Html.TextAreaFor(m => m.Notes, additionalViewData: new { htmlAttributes = new { @class = "form-control" }}) *@
                <span asp-validation-for="Notes" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <label asp-for="CreateDate" class="col-lg-3 col-form-label form-control-label control-label"></label>
            <div class="col-lg-3 mycalendar">
                <input asp-for="CreateDate" class="form-control" type="text" readonly/>
                <span asp-validation-for="CreateDate" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-lg-3">
                <a asp-action="Index" class="btn btn-light"><i class="fa fa-arrow-left"></i> Zpět</a>
            </div>
            <div class="col-lg-9">
                <input type="reset" class="btn btn-secondary" value="Resetovat pole" data-toggle="tooltip" title="Vrátí neuložené úpravy"/>
                <input type="submit" class="btn btn-primary" name="actionType" value="Uložit" />
                <input type="submit" class="btn btn-primary" name="actionType" value="Uložit a zavřít" />
                @* <input type="submit" class="btn btn-primary" name="actionType" value="Smazat" /> *@
                <a href="#" class="btn btn-danger pull-right" onclick="ConfirmDelete(@Model.OfferId)">Smazat</a>
            </div>
        </div>

        </form>
    </div>
</div>


<!-- Modal Confirm Delete-->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <!-- header -->
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Smazání nabídky</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <!-- body -->
            <div class="modal-body">
                Opravdu smazat?<br />
                Ev. Číslo: <b>@Model.OfferName</b><br />
                Předmět: <b>@Model.Subject</b>
            </div>
            <!-- footer -->
            <div class="modal-footer">
                <a href="#" class="btn btn-info" data-dismiss="modal">Zpět</a>
                <a href="#" class="btn btn-warning" onclick="DeactivateItem()">Deaktivovat</a>
                <a href="#" class="btn btn-danger" onclick="DeleteItem()">Smazat</a>
            </div>
        </div>
    </div>
</div>


@section Scripts {

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/CustomValidation.js"></script>

    <script>

        // MODAL dialog for delete confirmation
        //-------------------------------------
        var ConfirmDelete = function (ItemId) {
            $("#deleteConfirmModal").modal('show');
        };

        // POST delete command to controller
        //----------------------------------
        function DeleteItem() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("Delete")',
                data: { Id: @Model.OfferId },
                success: function () {
                    $("#deleteConfirmModal").modal("hide")
                    window.location.href = '../'
                },
                error: function() {
                    alert("Nelze z nějakého důvodu odstranit...");
                    $("#deleteConfirmModal").modal("hide");
                }
            })
        }

        // POST deactivate command to controller
        //----------------------------------
        function DeactivateItem() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("Deactivate")',
                data: { Id: @Model.OfferId },
                success: function () {
                    $("#deleteConfirmModal").modal("hide")
                    window.location.href = './' + @Model.OfferId
                },
                error: function() {
                    alert("Nelze z nějakého důvodu deaktivovat...");
                    $("#deleteConfirmModal").modal("hide");
                }
            })
        }

        $(document).ready(function(){

            $('.mycalendar input').datepicker({
                // format: "dd.mm.yyyy",
                // startDate: "01.01.1980",
                // endDate: "01.01.2021",
                format: "yyyy-mm-dd",
                startDate: "1980-01-01",
                endDate: "2021-01-01",
                todayBtn: "linked",
                language: "cs",
                daysOfWeekHighlighted: "0,6",
                calendarWeeks: true,
                autoclose: true,
                todayHighlight: true
            });

            // By default, .offerWon/Lost/Wait divs are hidden
            // Depending on the Status (Won), show Modifiable divs (Wait, Lost)
            switch(@Model.OfferStatusId) {
                case 1:
                    $('.offerWon').show();
                    $('.offerLost').show();
                    break;
                case 2:
                    $('.offerWait').show();
                    $('.offerLost').show();
                    $('.createOffer').show();
                    break;
                case 3:
                    $('.offerWait').show();
                    $('.offerWon').show();
                    break;
            }

            function changeExchangeRate(curSymbol) {
                $.ajax({
                    url: '@Url.Action("getCurrencyStr", "Offers")',
                    type: 'GET',
                    //dataType: 'json',
                    // we set cache: false because GET requests are often cached by browsers
                    // IE is particularly aggressive in that respect
                    cache: false,
                    data: { symbol: curSymbol },
                    success: function (res) {
                        $('#ExchangeRate').val(res);
                    }
                });
            }


            $('#CurrencyId').change(function() {
                var sel = document.getElementById('CurrencyId');
                var opt = sel.options[sel.selectedIndex];
                curSymbol = opt.text
                //console.log("Changing... to " + curSymbol);
                changeExchangeRate(curSymbol);
            });


            $("#ExchangeRate").on("keydown input change textInput", function (e) {
                // allow function keys and decimal separators
                if (
                    // backspace, delete, tab, escape, enter, comma and .
                    $.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 188, 190]) !== -1 ||
                    // Ctrl/cmd+A, Ctrl/cmd+C, Ctrl/cmd+X
                    ($.inArray(e.keyCode, [65, 67, 88]) !== -1 && (e.ctrlKey === true || e.metaKey === true)) ||
                    // home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {

                    // // optional: replace commas with dots in real-time (for en-US locals)
                    // if (e.keyCode === 188) {
                    //     e.preventDefault();
                    //     $(this).val($(this).val() + whatDecimalSeparator());
                    // }

                    // // optional: replace decimal points (num pad) and dots with commas in real-time (for EU locals)
                    // if (e.keyCode === 110 || e.keyCode === 190) {
                    //     e.preventDefault();
                    //     $(this).val($(this).val() + whatDecimalSeparator());
                    // }

                    return;
                }
                // block any non-number
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });

            function whatDecimalSeparator() {
                var n = 1.1;
                n = n.toLocaleString().substring(1, 2);
                return n;
            };

        });

    </script>

}

