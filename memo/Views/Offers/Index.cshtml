@using System.Globalization;

@{
    ViewData["Title"] = "Nabídky/Objednávky";
}

@model IList<memo.Models.Offer>

<style>
    .notesWrap {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .centerHeader {
        text-align: center;
    }
    @* .container {
        max-width: 1680px;
    } *@

    th {
        font-weight: 400;
    }
</style>


<div class="text-center">
    <h1 class="display-4">@ViewData["Title"]</h1>
</div>

<div class="text-center">
    <div data-toggle="tooltip" title="Zobrazit legendu">
        <a class="btn btn-light" href="#showLegend" data-toggle="collapse" role="button" >
            <i class="fa fa-question-circle-o"></i>
        </a>
    </div>
</div>

<div class="card collapse text-center" id="showLegend">
    <h4 class="pb-2">Legenda</h4>
    <ul class="p-0" style="list-style-type:none">
        <li class="pb-3">
            <span class="badge badge-secondary">Čeká</span>  <br />
            Nabídka, která je v řešení.
        </li>
        @* <li>&nbsp;</li> *@
        <li class="pb-3">
            <span class="badge badge-success">Výhra</span> <br />
            Nabídka se stává objednávkou. Možno založit jednu/více zakázek.
        </li>
        @* <li>&nbsp;</li> *@
        <li class="pb-3">
            <span class="badge badge-danger">Prohra</span> <br />
            Nevyhraná nabídka. Je dobré ji deaktivovat.
        </li>
    </ul>
</div>

<div id="toolbar" style="padding-bottom: 10px;">
    <a asp-action="Create" class="btn btn-outline-success"><i class="fa fa-plus-square-o"></i> Nová nabídka</a>
    @* <a id="btnToggleActive" class="btn btn-outline-primary pull-right" onclick="ToggleActive()">
        <i class="fa fa-eye-slash"></i> Aktivní (@Model.Count(m => m.Active) / @Model.Count())
    </a> *@
    <button style="margin-right: 5px;" class="btn btn-outline-info" name="BtnMujFilter" id="BtnMujFilter" type="button">
        <i class="fa fa-filter"> Filter</i>
    </button>
</div>


<table
    id="table"
    class="table table-sm text-xsmall text-nowrap"
    @* style="width:100%" *@
    data-cookie="true"
    data-cookie-id-table="saveId"
    data-filter-control="false"
    data-footer-style="footerStyle"
    data-maintain-meta-data="true"
    data-show-search-clear-button="true"
    data-show-toggle="true"
    data-show-columns-toggle-all="true"
    data-show-columns="true"
    data-show-fullscreen="true"
    data-sort-name="ReceiveDate"
    data-sort-order="desc"
    data-search="true"
    data-silent-sort="true"
    data-show-footer="true"
    data-toolbar="#toolbar"
    data-toggle="table"
    data-visible-search="true"
    @* data-reorderable-columns="true" *@
    @* data-show-pagination-switch="true" *@
    @* data-pagination="true" *@
    @* data-height="800" *@
    @* data-page-size="50" *@
    @* data-page-list="[10, 25, 50, 100, 200, All]" *@
    style="font-size: 0.9em;"
    >
    <thead>
        <tr>
            <th class="text-center" scope="col" data-field="Id" data-sortable="true" data-filter-control="input" data-footer-formatter="idFormatter"  ><i class="fa fa-arrows-v" aria-hidden="true"></i> Id</th>
            <th class="text-center" scope="col" data-field="Status" data-sortable="true" data-filter-control="input">Status</th>
            <th class="text-center" scope="col" data-field="CreateDate" data-sortable="true" data-filter-control="input">Vytvořeno</th>
            <th class="text-center" scope="col" data-field="Name" data-sortable="true" data-filter-control="input">Název</th>
            <th class="text-center" scope="col" data-field="ReceiveDate" data-sortable="true" data-filter-control="input">Přijato</th>
            <th class="text-center" scope="col" data-field="Company" data-sortable="true" data-filter-control="input">Firma</th>
            <th class="text-center" scope="col" data-field="Contact" data-sortable="true" data-filter-control="input">Kontakt</th>
            <th class="text-center" scope="col" data-field="Subject" data-sortable="true" data-filter-control="input">Předmět</th>
            <th class="text-center" scope="col" data-field="Price" data-sortable="true" data-filter-control="input">Cena</th>
            <th class="text-center" scope="col" data-field="Currency" data-sortable="true" data-filter-control="input">Měna</th>
            <th class="text-center" scope="col" data-field="PriceCzk" data-sortable="true" data-filter-control="input">Cena<br/>[CZK]</th>
            <th class="text-center" scope="col" data-field="Notes" data-sortable="true" data-filter-control="input">Poznámky</th>
            <th class="text-center" scope="col" data-field="Active" data-sortable="true" data-filter-control="select">Aktivní</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            @* <tr id="row_@item.OfferId" class="@(item.Active ? Html.Raw("show") : Html.Raw("hide"))"> *@
            <tr id="row_@item.OfferId">
                <th scope="row" data-field="0" >
                    <a asp-action="Edit" asp-route-id=@item.OfferId><i class="fa fa-pencil fa-fw" aria-hidden="true"></i></a>
                    <a href="#" onclick="ConfirmDelete(@item.OfferId)"><i class="fa fa-times fa-fw" style="color: red;", aria-hidden="true"></i></a>
                </th>
                @* OfferStatus - VyhraProhra *@
                @if (item.OfferStatusId == 1)
                {
                    <th scope="row" class="text-left" ><span class="badge badge-secondary">@item.OfferStatus?.Name</span></th>
                }
                else if (item.OfferStatusId == 2)
                {
                    <th scope="row" class="text-left" ><span class="badge badge-success">@item.OfferStatus?.Name</span></th>
                }
                else
                {
                    <th scope="row" class="text-left" ><span class="badge badge-danger">@item.OfferStatus?.Name</span></th>
                }
                @{ string dateText = item.CreateDate.HasValue != false ? item.CreateDate.Value.ToString("yyyy-MM-dd") : ""; }
                <th scope="row" class="text-left">@dateText</th>
                <th scope="row" class="text-left">@item.OfferName</th>
                <th scope="row" class="text-left">@item.ReceiveDate.Value.ToString("yyyy-MM-dd")</th>
                <th scope="row" class="text-left">@item.Company?.Name</th>
                <th scope="row" class="text-left">@item.Contact?.PersonTitle @item.Contact?.PersonName @item.Contact?.PersonLastName </th>
                <th scope="row" class="notesWrap" data-toggle="tooltip" data-placement="top" data-html="true" title="@item.Subject">
                    @item.Subject
                </th>
                @* <th scope="row" class="text-left" >@item.Price</th> *@
                <th scope="row" class="text-right">@String.Format(CultureInfo.CreateSpecificCulture(@item.Currency.CultureCode), "{0:C0}", @item.Price)</th>
                <th scope="row" class="text-center" >@item.Currency?.Name</th>
                <th scope="row" class="text-right">@String.Format(CultureInfo.CreateSpecificCulture("cs-CZ"), "{0:C0}", @item.PriceCzk)</th>
                <th scope="row" class="notesWrap" data-toggle="tooltip" data-placement="top" data-html="true" title="@item.Notes">
                    @item.Notes
                </th>

                @* Status *@
                @if (item.Active is true)
                {
                    <th scope="row" class="text-center" ><span class="badge badge-info">Aktivní</span></th>
                }
                else if (item.Active is false)
                {
                    <th scope="row" class="text-center" ><span class="badge badge-secondary">Neaktivní</span></th>
                }

            </tr>
        }
    </tbody>
</table>


<!-- Modal Confirm Delete-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <!-- header -->
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Smazání nabídky</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <!-- body -->
            <div class="modal-body">
                Opravdu smazat?
                <span id="modalItemId"></span>
            </div>
            <!-- footer -->
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Zpět</a>
                <a href="#" class="btn btn-danger" onclick="DeleteItem()">Smazat</a>
            </div>
        </div>
    </div>
</div>

@*hidden field for storing current Id*@
<input type="hidden" id="hiddenId" />

@section scripts{
<script>
    // POST delete command to controller
    //----------------------------------
    function DeleteItem() {
        var itemId = $("#hiddenId").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("Delete", "Offers")',
            data: { Id: itemId },
            success: function () {
                $("#myModal").modal("hide")
                //$("#row_" + itemId).remove();
                window.location = "Index"
            },
            error: function() {
                alert("Tento nabídka nelze z nějakého důvodu odstranit...");
                $("#myModal").modal("hide");
            }
        })
    }


    // MODAL dialog for delete confirmation
    //-------------------------------------
    var ConfirmDelete = function (ItemId) {
        $("#hiddenId").val(ItemId);
        $("#myModal").modal('show');
        $("#modalItemId").val( 'Hmm' + ItemId );
    };


    // Function to toggle Active/Disabled Contacts/Companies in table
    //---------------------------------------------------------------
    function ToggleActive() {
        var btn = document.getElementById("btnToggleActive");

        if (btn.children[0].className == "fa fa-eye-slash") {
            // Change icon and text
            btn.children[0].className = "fa fa-eye"
            btn.lastChild.nodeValue = " Všichni (@Model.Count())"
            // Get class('hide') elements and copy to normal array
            //var hiddenRows = document.getElementsByClassName("hide");
            //elementArray = [].slice.call(hiddenRows, 0);
            //for(var i = elementArray.length - 1; i >= 0; i--){
            //    hiddenRows[i].className = "show hiddenBefore";
            //};

            var hiddenRows = document.querySelectorAll(".hide");
            console.log(hiddenRows);
            for(var i = 0; i < hiddenRows.length; i++){
                hiddenRows[i].className = "show hiddenBefore";
            }

        }
        else {
            // Change icon and text
            btn.children[0].className = "fa fa-eye-slash"
            btn.lastChild.nodeValue = " Aktivní (@Model.Count(m => m.Active) / @Model.Count())"
            // Get class('show hiddenBefore') elements and copy to normal array
            //var hiddenRows = document.getElementsByClassName("show hiddenBefore");
            //elementArray = [].slice.call(hiddenRows, 0);
            //for(var i=0; i<elementArray.length; i++){
            //    elementArray[i].className = "hide";
            //}
            var hiddenRows = document.querySelectorAll(".show.hiddenBefore");
            for(var i = 0; i < hiddenRows.length; i++){
                hiddenRows[i].className = "hide";
            }
        }
    }

    function idFormatter() {
        return 'Total'
    }

    function nameFormatter(data) {
        return data.length
    }

    function priceFormatterCz(data) {
        var field = parseInt(this.field.replace(",", "").replace("&nbsp;", "").replace(" ", "").replace("Kč", ""));
        console.log(field);
        //var field = parseInt(this.field).val().replace(/[^0-9]/g, '')
        var vysledek = data.map(function (row) {
            var cost = parseInt(row[field]
                //.replace(/, (Kč)(&nbsp);/g, ''));
                .replace(",", "")
                .replace("&nbsp;", "")
                .replace(" ", "")
                .replace("Kč", ""));
            return + cost
        }).reduce(function (sum, i) {
            return sum + i
        }, 0)
        return vysledek.toLocaleString('cs-CZ') + ' Kč'
    }

    function priceFormatter(data) {
        var field = parseInt(this.field.replace(",", "").replace("&nbsp;", "").replace(" ", "").replace("Kč", ""));
        console.log(field);
        //var field = parseInt(this.field).val().replace(/[^0-9]/g, '')
        var vysledek = data.map(function (row) {
            var cost = parseInt(row[field]
                //.replace(/, (Kč)(&nbsp);/g, ''));
                .replace(",", "")
                .replace("&nbsp;", "")
                .replace(" ", "")
                .replace("Kč", ""));
            return + cost
        }).reduce(function (sum, i) {
            return sum + i
        }, 0)
        return vysledek
    }

    function footerStyle(row, index) {
        return {
            css: {
            "font-weight": "bold"
            }
        };
    };

</script>
}